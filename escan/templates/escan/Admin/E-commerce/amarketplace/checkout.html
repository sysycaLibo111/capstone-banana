<!-- u_checkout.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <style>
        :root {
            --dark-brown: #2F1609;
            --medium-brown: #704210;
            --light-brown: #96500E;
            --gold: #DA9408;
            --light-gold: #FBD576;
            --bright-gold: #FBD242;
            --white: #FFFFFF;
            --light-bg: #FFF9EC;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--dark-brown);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .checkout-container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
        }

        .card {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: none;
            overflow: hidden;
        }

        .card-header {
            background-color: var(--medium-brown);
            color: var(--white);
            padding: 20px;
            font-size: 1.5rem;
            font-weight: 600;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .card-body {
            padding: 0;
        }

        .section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .section-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--medium-brown);
            display: flex;
            align-items: center;
        }

        .section-header i {
            margin-right: 10px;
            color: var(--gold);
        }

        .product-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .product-info img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
        }

        .product-details h5 {
            margin: 0 0 5px 0;
            color: var(--dark-brown);
        }

        .product-details p {
            margin: 3px 0;
            font-size: 0.9rem;
            color: #555;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            border-color: var(--gold);
            outline: none;
            box-shadow: 0 0 0 2px rgba(218, 148, 8, 0.2);
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }

        .col {
            flex: 1;
            padding: 0 10px;
            min-width: 0;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-method:hover {
            border-color: var(--gold);
        }

        .payment-method input {
            margin-right: 10px;
        }

        .payment-method label {
            margin: 0;
            display: flex;
            align-items: center;
            width: 100%;
            cursor: pointer;
        }

        .payment-method i {
            margin-right: 10px;
            color: var(--gold);
            font-size: 1.2rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .summary-total {
            font-weight: 600;
            font-size: 1.1rem;
            margin: 15px 0;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            width: 100%;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--gold);
        }

        .btn-primary:hover {
            background-color: var(--light-brown);
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn i {
            margin-right: 8px;
        }

        .address-box {
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #eee;
        }

        .address-box p {
            margin: 5px 0;
        }

        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-check-input {
            margin-right: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .button-group .btn {
            flex: 1;
        }

        .shipping-estimate {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid var(--gold);
        }

        @media (max-width: 768px) {
            .checkout-container {
                padding: 10px;
            }
            
            .card-header {
                padding: 15px;
                font-size: 1.3rem;
            }
            
            .section {
                padding: 15px;
            }
            
            .product-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .product-info img {
                margin-bottom: 10px;
                margin-right: 0;
            }
            
            .row {
                flex-direction: column;
                margin: 0;
            }
            
            .col {
                padding: 0;
                margin-bottom: 15px;
            }

            .button-group {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .card-header {
                font-size: 1.2rem;
                padding: 12px;
            }
            
            .section-header {
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    
    <div class="checkout-container">
        <div class="card">
            <div class="card-header">
                Checkout
            </div>
            
            <div class="card-body">
                <!-- Order Summary Section -->
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-shopping-bag"></i>
                        <span>Order Summary</span>
                    </div>
                    
                    {% if is_u_direct_checkouts %}
                        <!-- Direct purchase summary -->
                        <div class="product-info">
                            {% if product.image %}
                            <img src="{{ product.image_url }}" alt="{{ product.name }}">
                            {% endif %}
                            <div class="product-details">
                                <h3>{{ product.name }}</h3>
                                <h5>Merchant: {{ store }}</h5>
                                <p>Quantity: {{ quantity }}</p>
                                <p>Price: â‚±{{ product.price }}</p>
                                <p>Shipping fee: â‚±{{ shipping_fee }}</p>
                                <p><strong>Total Amount: â‚±{{ total_amount|floatformat:2 }}</strong></p>
                            </div>
                        </div>
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input type="hidden" name="store_id" value="{{ store.id }}">
                        <input type="hidden" name="quantity" value="{{ quantity }}">
                    {% else %}
                        <!-- Cart checkout summary -->

    {% for item in cart_items %}
    <div class="product-info">
        {% if item.product.image %}
        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
        {% endif %}
        <div class="product-details">
            <h5>{{ item.product.name }}</h5>
            <p>Quantity: {{ item.quantity }}</p>
            <p>Price: â‚±{{ item.product.price }}</p>
            <p><strong>Item Total: â‚±{{ item.get_total|floatformat:2 }}</strong></p>
        </div>
    </div>
    {% endfor %}
     <hr>
    <div class="summary-item">
        <strong>Cart Subtotal:</strong>
        <span>â‚±{{ cart_total|floatformat:2 }}</span>
    </div>
    <div class="summary-item">
        <strong>Total Items:</strong>
        <span>{{ item_count }}</span>
    </div>
    <div class="summary-item">
        <strong>Shipping Fee:</strong>
        <span>â‚±{{ shipping_fee|floatformat:2 }}</span>
    </div>
    <div class="summary-item summary-total">
        <strong>Total Amount:</strong>
        <span>â‚±{{ total_amount|floatformat:2 }}</span>
    </div>
                    {% endif %}
                </div>
                
                <!-- Shipping Information Section -->
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-truck"></i>
                        <span>Shipping Information</span>
                    </div>
                    
                    <form method="POST" id="checkout-form">
                        {% csrf_token %}
                        
                        {% if has_address %}
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="use_existing_address" id="use-existing-address" checked>
                                <label class="form-check-label" for="use-existing-address">
                                    Use my existing address
                                </label>
                            </div>
                            <div class="address-box">
                                <p><strong>Address:</strong> {{ shipping_address.address }}</p>
                                <p><strong>City:</strong> {{ shipping_address.city }}</p>
                                <p><strong>Province:</strong> {{ shipping_address.province }}</p>
                                <!-- <p><strong>Zip Code:</strong> {{ shipping_address.zipcode }}</p> -->
                                <p><strong>Phone:</strong> {{ shipping_address.phone_number }}</p>
                            </div>
                            

                        </div>
                        {% endif %}
                        
                        <div id="new-address-form" {% if has_address %}style="display: none;"{% endif %}>
                            <div class="form-group">
                                <label for="phone_number" class="form-label">Phone Number</label>
                                <input type="text" class="form-control" id="phone_number" name="phone_number" 
                                       value="{% if has_address %}{{ shipping_address.phone_number }}{% endif %}" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="address" class="form-label">Address</label>
                                <input type="text" class="form-control" id="address" name="address" 
                                       value="{% if has_address %}{{ shipping_address.address }}{% endif %}" required>
                            </div>
                            
                            <div class="row">
                                <div class="col">
                                    <div class="form-group">
                                        <label for="city" class="form-label">City</label>
                                        <input type="text" class="form-control" id="city" name="city" 
                                               value="{% if has_address %}{{ shipping_address.city }}{% endif %}" required>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-group">
                                        <label for="province" class="form-label">Province</label>
                                        <input type="text" class="form-control" id="province" name="province" 
                                               value="{% if has_address %}{{ shipping_address.province }}{% endif %}" required>
                                    </div>
                                </div>
                                <!-- <div class="col">
                                    <div class="form-group">
                                        <label for="zipcode" class="form-label">Zip Code</label>
                                        <input type="text" class="form-control" id="zipcode" name="zipcode" 
                                               value="{% if has_address %}{{ shipping_address.zipcode }}{% endif %}" required>
                                    </div>
                                </div> -->
                            </div>
                            <!-- ðŸŸ¢ Buttons: Update & Cancel -->
                            <div class="form-group mt-2">
                                <div style="display: flex; gap: 10px;">
                                    <button type="submit" id="update-address-btn" name="action" value="update_address"
                                            class="btn btn-sm btn-outline-primary" style="background-color: #FBD242;">
                                        <i class="fas fa-sync"></i> Update Address
                                    </button>

                                    <button type="button" id="cancel-new-address-btn" class="btn btn-sm btn-secondary">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>


                        </div>
                    </form>
                </div>
                
                <!-- Payment Method Section -->
                <!-- <div class="section">
                    <div class="section-header">
                        <i class="fas fa-credit-card"></i>
                        <span>Payment Method</span>
                    </div>
                    
                    {% for method in PAYMENT_METHOD_CHOICES %}
                        {% if method.0 == 'COD' %}
                        <div class="payment-method">
                            <input type="radio" name="payment_method" id="payment-{{ method.0 }}" 
                                   value="{{ method.0 }}" checked form="checkout-form">
                            <label for="payment-{{ method.0 }}">
                                <i class="fas fa-money-bill-wave"></i>
                                {{ method.1 }}
                            </label>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div> -->
                <!-- Payment Method Section -->
<div class="section">
    <div class="section-header">
        <i class="fas fa-credit-card"></i>
        <span>Payment Method</span>
    </div>

    {% for method in PAYMENT_METHOD_CHOICES %}
        <div class="payment-method">
            <input type="radio" name="payment_method" id="payment-{{ method.0 }}"
                   value="{{ method.0 }}" {% if method.0 == 'COD' %}checked{% endif %} form="checkout-form">
            <label for="payment-{{ method.0 }}">
                {% if method.0 == 'COD' %}
                    <i class="fas fa-money-bill-wave"></i>
                {% elif method.0 == 'GCASH' %}
                    <i class="fab fa-google-wallet"></i> {# GCash icon substitute #}
                    <input type="hidden" id="gcash_number" name="gcash_number" value="">
                {% endif %}

                {{ method.1 }}
            </label>
        </div>
    {% endfor %}
</div>




                <!-- Order Total Section -->
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-receipt"></i>
                        <span>Order Total</span>
                    </div>
                    
                    {% if is_u_direct_checkouts %}
                        <div class="summary-item">
                            <span>Subtotal:</span>
                            <span>â‚±{{ subtotal|floatformat:2 }}</span>
                        </div>
                        <div class="summary-item">
                            <span>Items:</span>
                            <span>{{ quantity }}</span>
                        </div>
                        {% if shipping_fee %}
                        <div class="summary-item">
                            <span>Shipping fee:</span>
                            <span>â‚±{{ shipping_fee|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="summary-item">
                            <span>Subtotal:</span>
                            <span>â‚±{{ cart_total|floatformat:2 }}</span>
                        </div>
                        <div class="summary-item">
                            <span>Items:</span>
                            <span>{{ item_count }}</span>
                        </div>
                        {% if shipping_fee %}
                        <div class="summary-item">
                            <span>Shipping fee:</span>
                            <span>â‚±{{ shipping_fee|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                    {% endif %}
                    
                    <div class="summary-item summary-total">
                        <span>Total:</span>
                        <span>â‚±{{ total_amount|floatformat:2 }}</span>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" form="checkout-form" name="action" value="place_order" class="btn btn-primary">
                            <i class="fas fa-shopping-bag"></i> Place Order
                        </button>
                        <a href="{% url 'a_market_place' %}" class="btn btn-secondary">
                            <i class="fas fa-store"></i> Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle between existing and new address
    const addressCheckbox = document.getElementById('use-existing-address');
    const newAddressForm = document.getElementById('new-address-form');
    const cancelBtn = document.getElementById('cancel-new-address-btn');
    
    if (addressCheckbox && newAddressForm) {
        addressCheckbox.addEventListener('change', function() {
            newAddressForm.style.display = this.checked ? 'none' : 'block';
        });
        
        // Initialize the form state
        newAddressForm.style.display = addressCheckbox.checked ? 'none' : 'block';
    }
    
    if (cancelBtn && newAddressForm && addressCheckbox) {
        cancelBtn.addEventListener('click', function() {
            newAddressForm.style.display = 'none';
            addressCheckbox.checked = true;
        });
    }
    
    // Handle form submission
    const checkoutForm = document.getElementById('checkout-form');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            // Validate the form based on whether using existing address or not
            const useExisting = document.getElementById('use-existing-address').checked;
            
            if (!useExisting) {
                // Validate new address fields
                const requiredFields = ['phone_number', 'address', 'city', 'province'];
                let isValid = true;
                
                requiredFields.forEach(field => {
                    const input = document.getElementById(field);
                    if (input && !input.value.trim()) {
                        isValid = false;
                        input.classList.add('is-invalid');
                    } else if (input) {
                        input.classList.remove('is-invalid');
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    alert('Please fill in all required address fields.');
                    return false;
                }
            }
            
            // Disable button to prevent double submission
            const submitButton = this.querySelector('button[type="submit"][name="action"][value="place_order"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
            }
        });
    }
    
    // Add a checkbox for setting address as default
    const addressForm = document.getElementById('new-address-form');
    if (addressForm && !addressForm.querySelector('#set-as-default')) {
        const checkboxHtml = `
            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" name="set_as_default" id="set-as-default">
                <label class="form-check-label" for="set-as-default">
                    Set as default address
                </label>
            </div>
        `;
        addressForm.insertAdjacentHTML('beforeend', checkboxHtml);
    }
});
</script>


    <!-- <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle between existing and new address
        const addressCheckbox = document.querySelector('input[name="use_existing_address"]');
        const newAddressForm = document.getElementById('new-address-form');
        
        if (addressCheckbox) {
            addressCheckbox.addEventListener('change', function() {
                newAddressForm.style.display = this.checked ? 'none' : 'block';
            });
        }
        
        // Disable button on submit to prevent multiple submissions
        const checkoutForm = document.getElementById('checkout-form');
        if (checkoutForm) {
            checkoutForm.addEventListener('submit', function() {
                const submitButton = this.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
            });
        }
        
        // Calculate shipping fee when zip code changes
        const zipcodeInput = document.getElementById('zipcode');
        if (zipcodeInput) {
            zipcodeInput.addEventListener('blur', function() {
                // In a real implementation, you would make an AJAX call to calculate shipping
                console.log('Zip code changed to:', this.value);
                // For now, we'll just show a message
                alert('Shipping fee will be calculated based on your zip code: ' + this.value);
            });
        }
    });

    // button in address fields
       document.addEventListener('DOMContentLoaded', function () {
        const cancelBtn = document.getElementById('cancel-new-address-btn');
        const newAddressForm = document.getElementById('new-address-form');
        const useExistingCheckbox = document.getElementById('use-existing-address');

        if (cancelBtn && newAddressForm && useExistingCheckbox) {
            cancelBtn.addEventListener('click', function () {
                // Hide the new address form
                newAddressForm.style.display = 'none';

                // Check the "Use existing address" checkbox again
                useExistingCheckbox.checked = true;
            });
        }

        // Optional: Show/hide new address form based on checkbox
        useExistingCheckbox?.addEventListener('change', function () {
            newAddressForm.style.display = this.checked ? 'none' : 'block';
        });
    });

    // credit/debit card fields
    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
        radio.addEventListener('change', function () {
            document.getElementById('card-payment-fields').style.display =
                this.value === 'CARD' ? 'block' : 'none';
        });
    });

    // gcash number
    document.addEventListener("DOMContentLoaded", function () {
        const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
        const phoneNumberInput = document.getElementById("phone_number");
        const gcashHiddenInput = document.getElementById("gcash_number");

        paymentMethods.forEach(method => {
            method.addEventListener("change", function () {
                if (this.value === "GCASH" && phoneNumberInput) {
                    gcashHiddenInput.value = phoneNumberInput.value;
                }
            });
        });

        // Optional: Update hidden input on phone number change
        phoneNumberInput?.addEventListener("input", function () {
            const selectedMethod = document.querySelector('input[name="payment_method"]:checked');
            if (selectedMethod?.value === "GCASH") {
                gcashHiddenInput.value = phoneNumberInput.value;
            }
        });
    });

    </script> -->
</body>
</html>